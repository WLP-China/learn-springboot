<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
    <style type="text/css">
        .toolbar {
            border: 1px solid #ccc;
        }
        .content {
            border: 1px solid #ccc;
            min-height: 500px;
        }
    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-card">
            <div class="layui-card-header">文章详情
                <button id="editBtn" type="button" class="layui-btn layui-btn-sm" style="float: right; margin-top: 5px;"
                        onclick='editBtn()'>编辑</button>
                <button id="returnBtn" type="button" class="layui-btn layui-btn-sm layui-btn-normal" style="float: right; margin-top: 5px; display:none"
                        onclick="location.href='singleArticle.html?id='+getUrlParam('id')+'&type='+getUrlParam('type')">取消编辑</button>
            </div>
            <div class="layui-card-body">
                <form class="layui-form layui-form-pane" lay-filter="form-filter">
                    <input type="hidden" id="id" name="id">
                    <input type="hidden" id="type" name="type">
                    <div class="layui-form-item">
                        <label class="layui-form-label">文章标题</label>
                        <div class="layui-input-block">
                            <input type="text" id="title" name="title" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input layui-disabled" disabled>
                        </div>
                    </div>
                    <div class="layui-row layui-col-space30 layui-form-item">
                        <div class="layui-col-lg4">
                            <label class="layui-form-label">发布时间</label>
                            <div class="layui-input-block">
                                <input type="text" id="publishTime" name="publishTime" lay-verify="required" lay-verify="required" placeholder="" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                        <div class="layui-col-lg4">
                            <label class="layui-form-label">是否置顶</label>
                            <div class="layui-input-block">
                                <input type="checkbox" id="isTop" name="isTop" value="1" lay-skin="switch" lay-text="是|否" disabled>
                            </div>
                        </div>
                        <div class="layui-col-lg4">
                            <label class="layui-form-label">是否发布</label>
                            <div class="layui-input-block">
                                <input type="checkbox" id="status" name="status" value="1" lay-skin="switch" lay-text="是|否" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">文章内容</label>
                        <div id="toolbar" class="toolbar" name='content'></div>
                        <div id="content" class="content" name='content' style="min-height:500px;"></div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block" align="center">
                            <button id="submit" class="layui-btn" lay-submit lay-filter="submit-form" style="display:none;">立即提交</button>
<!--                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>-->
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../js/plugin/wangEditor3.1.1/wangEditor.min.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>

<script type="text/javascript">
    var E = window.wangEditor;
    var editor = new E('#toolbar','#content');
    // 自定义菜单配置
    editor.customConfig.menus = [
        'head',  // 标题
        'bold',  // 粗体
        'fontSize',  // 字号
        'fontName',  // 字体
        'italic',  // 斜体
        'underline',  // 下划线
        'strikeThrough',  // 删除线
        'foreColor',  // 文字颜色
        'backColor',  // 背景颜色
        'link',  // 插入链接
        'list',  // 列表
        'justify',  // 对齐方式
        'quote',  // 引用
        // 'emoticon',  // 表情
        'image',  // 插入图片
        'table',  // 表格
        // 'video',  // 插入视频
        // 'code',  // 插入代码
        'undo',  // 撤销
        'redo'  // 重复
    ];
    // 关闭粘贴样式的过滤
    editor.customConfig.pasteFilterStyle = false;

    var pro = window.location.protocol;
    var host = window.location.host;
    var domain = pro + "//" + host;

    editor.customConfig.uploadImgServer = '/files/wangEditor'// 配置服务器端地址
    editor.customConfig.uploadFileName = 'file' //自定义fileName
    editor.customConfig.uploadImgParams = {//自定义上传参数
        token: localStorage.getItem("token"),
        domain: domain
    }
    // editor.customConfig.uploadImgHeaders = {//自定义 header
    //     'Content-Type': 'multipart/form-data'
    // }
    editor.customConfig.uploadImgMaxLength = 5; //限制一次最多能传几张图片,默认为 10000 张（即不限制）
    //editor.customConfig.uploadImgMaxSize =5 * 1024 * 1024; //限制图片大小 默认5M
    //editor.customConfig.uploadImgParamsWithUrl = true//是否需要将参数拼接到 url 中
    //editor.customConfig.withCredentials = true//（跨域传递 cookie）跨域上传中如果需要传递 cookie 需设置 withCredentials
    //editor.customConfig.uploadImgTimeout = 3000 //自定义 timeout 时间，默认10秒钟
    //监听函数
    editor.customConfig.uploadImgHooks = {
        before: function (xhr, editor, files) {
            // 图片上传之前触发
            // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，files 是选择的图片文件
            // 如果返回的结果是 {prevent: true, msg: 'xxxx'} 则表示用户放弃上传
            // return {
            //     prevent: true,
            //     msg: '放弃上传'
            // }
        },
        success: function (xhr, editor, result) {
            // 图片上传并返回结果，图片插入成功之后触发
            // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，result 是服务器端返回的结果
            console.log("success");
            console.log(result);
        },
        fail: function (xhr, editor, result) {
            // 图片上传并返回结果，但图片插入错误时触发
            console.log("fail");
            console.log(result);
        },
        error: function (xhr, editor) {
            // 图片上传出错时触发
        },
        timeout: function (xhr, editor) {
            // 图片上传超时时触发
        },
    }
    editor.create();

    editor.$textElem.attr('contenteditable', false)
    function editBtn() {
        $("#title").attr("disabled", false);
        $("#title").removeClass("layui-disabled");
        $("#publishTime").attr("disabled", false);
        $("#publishTime").removeClass("layui-disabled");
        $("#isTop").attr("disabled", false);
        $("#isTop").removeClass("layui-disabled");
        $("#status").attr("disabled", false);
        $("#status").removeClass("layui-disabled");
        editor.$textElem.attr('contenteditable', true)

        $("#returnBtn").show();
        $("#submit").show();
        $("#editBtn").hide();
    }

    layui.use(['layer', 'form', 'laydate'], function () {
        var layer = layui.layer;
        var laydate = layui.laydate;
        var form = layui.form;

        $(this).removeAttr("lay-key");
        laydate.render({
            elem: '#publishTime',
            trigger: 'click'
        });
        // var data = form.val('example');

        let atype = getUrlParam("type");
        let id = getUrlParam("id");
        initData();
        function initData() {
            $("#type").val(atype);
            if (isNotEmpty(id)) {
                $.ajax({
                    type: 'get',
                    url: '/article/' + id,
                    async: false,
                    success: function (data) {
                        console.log(data)
                        form.val('form-filter', {
                            "id": data.id,
                            "title": data.title,
                            "publishTime": data.publishTime,
                            "isTop": data.isTop==1?true:false,
                            "status": data.status==1?true:false
                        });
                        editor.txt.html(data.content)
                    }
                });
            }
        }
        form.on('submit(submit-form)', function (data) {
            let request_data = data.field;
            request_data.content=editor.txt.html()
            $.ajax({
                type: 'post',
                url: '/article',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(request_data),
                success: function (data) {
                    if (data.code == 200) {
                        layer.msg("操作成功", {shift: -1, time: 1000}, function () {
                            location.href = "singleArticle.html?id=" + id + "type=" + atype;
                        });
                    }else {
                        layer.msg(data.message, {shift: -1, time: 1000}, function () {
                        });
                    }
                }
            });
            return false;
        });
    });
</script>
</body>
</html>
